name: TGD - High Speed Link

on:
  workflow_dispatch:
    inputs:
      url:
        description: 'Download URL'
        required: true
        type: string

jobs:
  tgd-task:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required to create releases
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y aria2
        pip install requests

    - name: Download File (Aria2 Beast Mode)
      id: download
      run: |
        URL="${{ github.event.inputs.url }}"
        # Extract filename
        FILENAME=$(basename "$URL" | cut -d? -f1)
        if [ -z "$FILENAME" ]; then FILENAME="file_$(date +%s).mp4"; fi
        
        echo "ðŸ“¥ Downloading $FILENAME"
        aria2c -x 16 -s 16 -k 1M --user-agent="Mozilla/5.0" --console-log-level=warn "$URL" -o "$FILENAME"
        
        echo "filename=$FILENAME" >> $GITHUB_OUTPUT
        echo "âœ… Download complete"

    - name: Upload to GitHub Release
      id: upload
      uses: softprops/action-gh-release@v2
      with:
        tag_name: "dl-$(date +%s)"
        name: "Download: ${{ steps.download.outputs.filename }}"
        files: ${{ steps.download.outputs.filename }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Notify Telegram
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        TELEGRAM_TO: ${{ secrets.TELEGRAM_TO }}
      run: |
        # Get the direct asset download URL
        # We find the specific file URL from the release assets
        DL_URL="https://github.com/${{ github.repository }}/releases/download/${{ steps.upload.outputs.tag_name }}/${{ steps.download.outputs.filename }}"
        python scripts/downloader.py "${{ steps.download.outputs.filename }}" "$DL_URL"